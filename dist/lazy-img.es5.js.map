{"version":3,"file":"lazy-img.es5.js","sources":["../src/lazy-img.js"],"sourcesContent":["'use strict';\n\nvar elementObservers = new WeakMap();\n\nfunction notifyEntries(entries) {\n  for(var i = 0; i < entries.length; i++) {\n    var entry = entries[i];\n    if (entry.intersectionRatio) {\n      entry.target.loadImage();\n    }\n  }\n}\n\nconst blankSrc = 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7';\n\nlet polyfillPromise;\nif ('IntersectionObserver' in window && 'IntersectionObserverEntry' in window && 'intersectionRatio' in window.IntersectionObserverEntry.prototype) {\n  polyfillPromise = Promise.resolve();\n} else {\n  const url = new URL('intersection-observer.js', document.currentScript.src);\n  polyfillPromise = new Promise(function(resolve, reject) {\n    var s = document.createElement(\"script\");\n    s.src = url.href;\n    s.onload = resolve;\n    s.onerror = reject;\n    document.documentElement.appendChild(s);\n  });\n}\n\nclass LazyImgElement extends HTMLElement {\n\n  static get observedAttributes() {\n    return ['alt', 'src', 'margin', 'threshold', 'observe'];\n  }\n\n  constructor() {\n    super();\n\n    this.shadow = this.attachShadow({ mode: 'open' });\n    this._img = document.createElement('img');\n    this._img.style.width = '100%';\n    this._img.style.height = '100%';\n    this._img.src = blankSrc;\n    this.shadow.appendChild(this._img);\n\n    this._margin =  '0px 0px 0px 0px';\n    this._threshold = 0.10;\n    this._observe = null;\n  }\n\n  connectedCallback() {\n    this.style.display = 'inline-block';\n  }\n\n  disconnectedCallback() {\n    this.stopObserving();\n  }\n\n  attributeChangedCallback(name, oldValue, newValue) {\n    if (oldValue === newValue) return;\n    this[name] = newValue;\n  }\n\n  get src() { return this._src; }\n  set src(value) {\n    this.stopObserving();\n    this.removeAttribute('loaded');\n    this._src = value;\n    this._img.src = blankSrc;\n    this.startObserving();\n    this.setAttribute('src', value);\n  }\n\n  get alt() { return this._alt; }\n  set alt(value) {\n    this._alt = this._img.alt = value;\n    this.setAttribute('alt', value);\n  }\n\n  get margin() { return this._margin; }\n  set margin(value) {\n    this._margin = value;\n    this.setAttribute('margin', value);\n  }\n\n  get threshold() { return this._threshold; }\n  set threshold(value) {\n    this._threshold = value;\n    this.setAttribute('threshold', value);\n  }\n\n  get observe() { return this._observe; }\n  set observe(value) {\n    this._observe = value;\n    this.setAttribute('observe', value);\n  }\n\n  /** load the image */\n  loadImage() {\n    this._img.onload = () => {\n      this.setAttribute('loaded', '');\n      var event = new Event('load');\n      event.detail = { originalTarget : this._img };\n      this.dispatchEvent(event);\n    };\n    this._img.src = this._src;\n    this.stopObserving();\n  }\n\n  /** stop observing visibility changes to this element */\n  stopObserving() {\n    if (this._observer) {\n      this._observer.unobserve(this);\n      if (--this._observer._lazyImgCount <= 0) {\n        this.deleteObserver(this._observer);\n      }\n      this._observer = null;\n    }\n  }\n\n  /** start observing for this element becoming visible */\n  startObserving() {\n    this.getObserver().then(observer => {\n      this._observer = observer;\n      this._observer.observe(this);\n      this._observer._lazyImgCount++;\n    });\n  }\n\n  /**\n   * get or create the observer for this element\n   *\n   * returns a promise so that IntersectionObserver\n   * can be polyfilled asynchronously and everything\n   * be wired up and created while that happens.\n   */\n  getObserver() {\n    return polyfillPromise.then(() => {\n      var observer;\n\n      // get element based on selector if there is one\n      var el = this._observe ? this.getClosest() : null;\n      var node = el || document.documentElement;\n\n      var options = {\n        root: el,\n        rootMargin: this._margin,\n        threshold: this._threshold\n      }\n      // See if there is already an observer created for the\n      // intersection options given. Note we perform a double\n      // lookup (map within a map) because the actual map key\n      // is a different instance and there is no hashing\n      var observersMap = elementObservers.get(node);\n      if (!observersMap) {\n        observersMap = new Map();\n        elementObservers.set(node, observersMap);\n      }\n\n      var key = options.rootMargin + '/' + options.threshold;\n      observer = observersMap.get(key);\n      if (!observer) {\n        // first time for this observer options combination\n        observer = new IntersectionObserver(notifyEntries, options);\n        observer._lazyImgKey = key;\n        observer._lazyImgCount = 0;\n        observersMap.set(key, observer);\n      };\n\n      return observer;\n    });\n  }\n\n  /** disconnect and delete an observer */\n  deleteObserver(observer) {\n    var observersMap = elementObservers.get(observer.root);\n    if (observersMap) {\n      observersMap.delete(observer._lazyImgKey);\n      if (observersMap.size === 0) {\n        elementObservers.delete(observer.root);\n      }\n    }\n    observer.disconnect();\n  }\n\n  /** get the closest element with the given selector */\n  getClosest() {\n    var el = this;\n    while (el.host || (el.matches && !el.matches(this._observe)))\n      el = el.host || el.parentNode;\n    return el.matches ? el : null;\n  }\n}\n\nwindow.customElements.define('lazy-img', LazyImgElement);\n"],"names":["notifyEntries","entries","i","length","entry","intersectionRatio","target","loadImage","elementObservers","WeakMap","blankSrc","polyfillPromise","window","IntersectionObserverEntry","prototype","Promise","resolve","url","URL","document","currentScript","src","reject","s","createElement","href","onload","onerror","documentElement","appendChild","LazyImgElement","shadow","_this","attachShadow","mode","_img","style","width","height","_margin","_threshold","_observe","display","stopObserving","name","oldValue","newValue","setAttribute","event","Event","detail","originalTarget","_this2","dispatchEvent","this","_src","_observer","unobserve","_lazyImgCount","deleteObserver","getObserver","then","observer","observe","el","_this4","getClosest","node","options","observersMap","get","Map","set","key","rootMargin","threshold","IntersectionObserver","_lazyImgKey","root","delete","size","disconnect","host","matches","parentNode","value","removeAttribute","startObserving","_alt","alt","HTMLElement","customElements","define"],"mappings":"wBAIA,SAASA,GAAcC,OACjB,GAAIC,GAAI,EAAGA,EAAID,EAAQE,OAAQD,IAAK,IAClCE,GAAQH,EAAQC,EAChBE,GAAMC,qBACFC,OAAOC,q0BANfC,EAAmB,GAAIC,SAWrBC,EAAW,iFAEbC,QACJ,IAAI,wBAA0BC,SAAU,6BAA+BA,SAAU,qBAAuBA,QAAOC,0BAA0BC,YACrHC,QAAQC,cACrB,IACCC,GAAM,GAAIC,KAAI,2BAA4BC,SAASC,cAAcC,OACrD,GAAIN,SAAQ,SAASC,EAASM,MAC1CC,GAAIJ,SAASK,cAAc,YAC7BH,IAAMJ,EAAIQ,OACVC,OAASV,IACTW,QAAUL,WACHM,gBAAgBC,YAAYN,QAInCO,gHASGC,OAASC,EAAKC,cAAeC,KAAM,WACnCC,KAAOhB,SAASK,cAAc,SAC9BW,KAAKC,MAAMC,MAAQ,SACnBF,KAAKC,MAAME,OAAS,SACpBH,KAAKd,IAAMX,IACXqB,OAAOF,YAAYG,EAAKG,QAExBI,QAAW,oBACXC,WAAa,KACbC,SAAW,+EAfR,MAAO,MAAO,SAAU,YAAa,mEAmBxCL,MAAMM,QAAU,mEAIhBC,iEAGkBC,EAAMC,EAAUC,GACnCD,IAAaC,SACZF,GAAQE,uDAuCRX,KAAKT,OAAS,aACZqB,aAAa,SAAU,OACxBC,GAAQ,GAAIC,OAAM,UAChBC,QAAWC,eAAiBC,EAAKjB,QAClCkB,cAAcL,SAEhBb,KAAKd,IAAMiC,KAAKC,UAChBZ,wDAKDW,KAAKE,iBACFA,UAAUC,UAAUH,QACnBA,KAAKE,UAAUE,eAAiB,QAC/BC,eAAeL,KAAKE,gBAEtBA,UAAY,+DAMdI,cAAcC,KAAK,cACjBL,UAAYM,IACZN,UAAUO,aACVP,UAAUE,yEAYV/C,GAAgBkD,KAAK,cACtBC,GAGAE,EAAKC,EAAKxB,SAAWwB,EAAKC,aAAe,KACzCC,EAAOH,GAAM7C,SAASS,gBAEtBwC,QACIJ,aACMC,EAAK1B,kBACN0B,EAAKzB,YAMd6B,EAAe7D,EAAiB8D,IAAIH,EACnCE,OACY,GAAIE,OACFC,IAAIL,EAAME,OAGzBI,GAAML,EAAQM,WAAa,IAAMN,EAAQO,mBAClCN,EAAaC,IAAIG,GACvBX,MAEQ,GAAIc,sBAAqB5E,EAAeoE,KAC1CS,YAAcJ,IACdf,cAAgB,IACZc,IAAIC,EAAKX,IAGjBA,2CAKIA,MACTO,GAAe7D,EAAiB8D,IAAIR,EAASgB,KAC7CT,OACWU,OAAOjB,EAASe,aACH,IAAtBR,EAAaW,QACED,OAAOjB,EAASgB,SAG5BG,yDAKLjB,GAAKV,KACFU,EAAGkB,MAASlB,EAAGmB,UAAYnB,EAAGmB,QAAQ7B,KAAKb,aAC3CuB,EAAGkB,MAAQlB,EAAGoB,UACrB,OAAOpB,GAAGmB,QAAUnB,EAAK,uCA/HRV,MAAKC,mBAChB8B,QACD1C,qBACA2C,gBAAgB,eAChB/B,KAAO8B,OACPlD,KAAKd,IAAMX,OACX6E,sBACAxC,aAAa,MAAOsC,qCAGR/B,MAAKkC,mBAChBH,QACDG,KAAOlC,KAAKnB,KAAKsD,IAAMJ,OACvBtC,aAAa,MAAOsC,wCAGL/B,MAAKf,sBAChB8C,QACJ9C,QAAU8C,OACVtC,aAAa,SAAUsC,2CAGL/B,MAAKd,yBAChB6C,QACP7C,WAAa6C,OACbtC,aAAa,YAAasC,yCAGV/B,MAAKb,uBAChB4C,QACL5C,SAAW4C,OACXtC,aAAa,UAAWsC,UAjEJK,YAqK7B9E,QAAO+E,eAAeC,OAAO,WAAY9D"}